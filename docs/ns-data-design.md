# NS æ•°æ®ç»“æ„ä¸å­˜å‚¨è®¾è®¡ï¼ˆns-data-design.mdï¼‰

**æ–‡æ¡£ID**ï¼šns-data-design
**æœ€åæ›´æ–°æ—¶é—´**ï¼š2025-09-04
**ç»´æŠ¤è€…**ï¼šT oï¼ˆæ€»æ¶æ„å¸ˆï¼‰ + AI åä½œæ”¯æŒ

---

## ğŸ¯ æ–‡æ¡£ç›®çš„

æœ¬æ–‡ä»¶å®šä¹‰ NS é¡¹ç›®æ ¸å¿ƒæ•°æ®ç»“æ„ã€çŠ¶æ€æ¨¡å‹ä¸ GCP å­˜å‚¨é€‰å‹ï¼Œç¡®ä¿æŠ“å–ä»»åŠ¡ã€è¿è¡ŒçŠ¶æ€ä¸æ—¥å¿—å…·å¤‡æ¸…æ™°çš„æ•°æ®è½ç‚¹ã€å¯æ¼”åŒ–çš„æ•°æ®ç»“æ„ä¸è‰¯å¥½çš„å¯æŸ¥è¯¢æ€§ã€‚

---

## ğŸ§± å­˜å‚¨é€‰å‹æ¦‚è§ˆ

| å­˜å‚¨ç±»å‹     | ç”¨é€”             | GCP æœåŠ¡                     | å­˜å‚¨æ ¼å¼            |
| -------- | -------------- | -------------------------- | --------------- |
| é…ç½®å‹æ•°æ®    | ç”¨æˆ·å‚æ•°é…ç½®         | Firestoreï¼ˆNative æ¨¡å¼ï¼‰       | æ–‡æ¡£å‹ JSON        |
| çŠ¶æ€å‹æ•°æ®    | æŠ“å–æ‰§è¡ŒçŠ¶æ€         | Firestore                  | æ–‡æ¡£å‹ JSONï¼ˆåˆ†çŠ¶æ€é›†åˆï¼‰ |
| å¯è§‚æµ‹æ€§æ•°æ®   | Trace æ—¥å¿— / å‘Šè­¦  | Cloud Logging / PubSub DLQ | ç»“æ„åŒ– JSON + æ—¥å¿—æ ‡ç­¾ |
| å¯¹è±¡å‹æ•°æ®    | ä¸´æ—¶ä¸‹è½½æ–‡ä»¶ / å‡½æ•°å‹ç¼©åŒ… | Cloud Storage              | ä»»æ„äºŒè¿›åˆ¶å¯¹è±¡         |
| å…ƒæ•°æ®/å¤±è´¥ä¿¡æ¯ | å¤±è´¥ä»»åŠ¡æ‘˜è¦         | Firestore `failures` é›†åˆ    | ç´¢å¼•åŒ– JSON        |

---

## ğŸ§© Firestore æ•°æ®ç»“æ„è®¾è®¡

### 1. `job_config` é…ç½®é›†åˆ

```json
{
  "job_id": "apod-daily",
  "active": true,
  "cron": "0 8 * * *",
  "fetch_url": "https://api.nasa.gov/...",
  "params": {
    "api_key": "..."
  },
  "post_process": true,
  "updated_at": "2025-09-04T00:00:00Z"
}
```

* ç”¨é€”ï¼šå‰ç«¯å±•ç¤ºä¸ç”¨æˆ·å¯ç¼–è¾‘å‚æ•°é…ç½®
* ä½¿ç”¨ Cloud Run å‰ç«¯è°ƒç”¨ Cloud Functions API å®æ—¶è¯»å–

### 2. `job_status` çŠ¶æ€é›†åˆ

```json
{
  "trace_id": "abc-123",
  "job_id": "apod-daily",
  "started_at": "2025-09-04T08:00:01Z",
  "status": "success", // "pending" | "running" | "error"
  "message": "Successfully fetched image",
  "duration_ms": 1784,
  "output_url": "gs://..."
}
```

* ç”¨é€”ï¼šä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹è¿½è¸ªä¸å†å²å½’æ¡£
* trace\_id æ¥è‡ªäº‹ä»¶é©±åŠ¨çš„ Pub/Sub æ¶ˆæ¯æ ‡è¯†

### 3. `failures` é›†åˆ

```json
{
  "trace_id": "def-456",
  "job_id": "neo-daily",
  "error_code": "HTTP_500",
  "message": "Upstream API timeout",
  "attempts": 3,
  "timestamp": "2025-09-04T08:10:22Z"
}
```

* æ¥æºï¼šPub/Sub æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰æˆ–å‡½æ•°å¼‚å¸¸å¤„ç†å™¨
* ç”¨äºåç»­å¤±è´¥åˆ†æã€ä»»åŠ¡çœ‹æ¿ã€è‡ªåŠ¨é‡è¯•å™¨ç­‰

---

## ğŸ“¦ å¯¹è±¡å­˜å‚¨ç»“æ„è®¾è®¡

### Cloud Storage Bucket

* å‘½åç¤ºä¾‹ï¼š`ns-temp-bucket`
* ç»“æ„ï¼š

  ```
  gs://ns-temp-bucket/
    apod-daily/
      2025-09-04/
        original.jpg
        meta.json
  ```
* ç”Ÿå‘½å‘¨æœŸç­–ç•¥ï¼š7 å¤©è¿‡æœŸæ¸…é™¤ä¸´æ—¶å¯¹è±¡

---

## ğŸ” æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

| é›†åˆ          | å»ºè®®ç´¢å¼•                       | æŸ¥è¯¢æ–¹å¼        |
| ----------- | -------------------------- | ----------- |
| job\_status | job\_id + started\_at DESC | æŸ¥çœ‹æŸä»»åŠ¡æœ€è¿‘æ‰§è¡Œæƒ…å†µ |
| failures    | job\_id + timestamp DESC   | æŸ¥çœ‹è¿‘æœŸå¤±è´¥ä»»åŠ¡æ‘˜è¦  |
| job\_config | job\_idï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰              | å¿«é€Ÿè¯»å–é…ç½®      |

âœ… Firestore ç´¢å¼•åœ¨æ§åˆ¶å°å¯è‡ªåŠ¨åˆ›å»ºï¼Œå¼€å‘æœŸå¯ä½¿ç”¨ CLI è„šæœ¬åˆå§‹åŒ–

---

## ğŸ§  æ•°æ®è®¾è®¡åŸåˆ™

1. **é…ç½®å³çŠ¶æ€**ï¼šé…ç½®æ•°æ®éœ€å¯çƒ­æ›´æ–°ã€å¯å›æ»šã€å¯å®¡è®¡
2. **çŠ¶æ€å³æ—¥å¿—**ï¼šçŠ¶æ€é›†åˆæ‰¿æ‹…ç³»ç»Ÿè¿½è¸ªä¸å¯è§†åŒ–åŠŸèƒ½
3. **å¤±è´¥å³äº‹ä»¶**ï¼šå¤±è´¥å¤„ç†ç»Ÿä¸€åŒ–ã€ç³»ç»ŸåŒ–ï¼Œé¿å…äººä¸ºä»‹å…¥
4. **ä¸´æ—¶å³æ¸…é™¤**ï¼šå¯¹è±¡å­˜å‚¨é‡‡ç”¨ç”Ÿå‘½å‘¨æœŸç­–ç•¥è‡ªåŠ¨æ¸…ç†
5. **æ— æ¡†æ¶ä¾èµ–**ï¼šé¿å… Firebase / ORM ç­‰é¢å¤–ä¾èµ–ï¼Œä¾¿äºæœ€å°åŒ–éƒ¨ç½²

---

## âœ… æ€»ç»“

NS é¡¹ç›®çš„æ•°æ®ç»“æ„åŸºäºï¼šäº‹ä»¶é©±åŠ¨ + çŠ¶æ€è¿½è¸ª + é…ç½®çƒ­æ›´æ–° ä¸‰å¤§åŸåˆ™ï¼Œç¡®ä¿ç»“æ„ç®€æ´ã€å¯æ§å¹¶æ”¯æŒé•¿æœŸæ¼”åŒ–ã€‚

ğŸ“„ æ¨èç»§ç»­é˜…è¯»ï¼š

* [`ns-technical-design.md`](./ns-technical-design.md)
* [`ns-security-policy.md`](./ns-security-policy.md)
* [`ns-architecture-summary.md`](./ns-architecture-summary.md)
